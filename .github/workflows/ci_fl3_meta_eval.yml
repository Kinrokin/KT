name: FL3 Meta Eval
on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  meta-eval-a:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install pytest
        run: python -m pip install --upgrade pip pytest
      - name: Run full FL3 + Temple batteries (A)
        env:
          PYTEST_DISABLE_PLUGIN_AUTOLOAD: "1"
          PYTHONPATH: KT_PROD_CLEANROOM/04_PROD_TEMPLE_V2/src:KT_PROD_CLEANROOM
        run: |
          python -m pytest -q KT_PROD_CLEANROOM/tests/fl3
          python -m pytest -q KT_PROD_CLEANROOM/04_PROD_TEMPLE_V2/tests
      - name: Rollback drill (A)
        env:
          PYTHONPATH: KT_PROD_CLEANROOM/04_PROD_TEMPLE_V2/src:KT_PROD_CLEANROOM
        run: python -m tools.verification.fl3_rollback_drill --registry-path KT_PROD_CLEANROOM/04_PROD_TEMPLE_V2/docs/RUNTIME_REGISTRY.json

  meta-eval-b:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install pytest
        run: python -m pip install --upgrade pip pytest
      - name: Run full FL3 + Cleanroom batteries (B)
        env:
          PYTEST_DISABLE_PLUGIN_AUTOLOAD: "1"
          PYTHONPATH: KT_PROD_CLEANROOM/04_PROD_TEMPLE_V2/src:KT_PROD_CLEANROOM
        run: |
          python -m pytest -q KT_PROD_CLEANROOM/tests/fl3
          python -m pytest -q KT_PROD_CLEANROOM/tests
      - name: Red assault (B)
        env:
          PYTHONPATH: KT_PROD_CLEANROOM/04_PROD_TEMPLE_V2/src:KT_PROD_CLEANROOM
        run: python -m tools.verification.fl3_red_assault

